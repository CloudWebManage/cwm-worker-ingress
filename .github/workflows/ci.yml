name: CI
on:
  push:
jobs:
  ci:
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v2
    - env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        sudo apt-get install -y python3-venv redis-tools &&\
        python3 -m venv venv &&\
        venv/bin/python3 -m pip install --upgrade pip &&\
        venv/bin/python3 -m pip install --upgrade setuptools wheel &&\
        venv/bin/python -m pip install -r requirements.txt &&\
        venv/bin/python -m pip install -e . &&\
        docker run -d --rm --name redis -p 6379:6379 redis
        [ "$?" != "0" ] && exit 1
        while ! redis-cli ping; do sleep 1; done
        DEBUG=yes REDIS_HOST=172.17.0.1 venv/bin/cwm_worker_ingress vdns 10053 &
        echo 172.17.0.1 cwm-worker-test.com | sudo tee -a /etc/hosts &&\
        . venv/bin/activate &&\
        ./run_tests.sh &&\
        echo "${GITHUB_TOKEN}" | docker login https://docker.pkg.github.com -u cloudwebmanage --password-stdin &&\
        docker pull docker.pkg.github.com/cloudwebmanage/cwm-worker-ingress/vdns:latest &&\
        docker pull docker.pkg.github.com/cloudwebmanage/cwm-worker-ingress/nginx:latest &&\
        docker build -t vdns --cache-from docker.pkg.github.com/cloudwebmanage/cwm-worker-ingress/vdns:latest . &&\
        docker build -t nginx --cache-from docker.pkg.github.com/cloudwebmanage/cwm-worker-ingress/nginx:latest nginx &&\
        docker tag vdns docker.pkg.github.com/cloudwebmanage/cwm-worker-ingress/vdns:$GITHUB_SHA &&\
        docker tag nginx docker.pkg.github.com/cloudwebmanage/cwm-worker-ingress/nginx:$GITHUB_SHA &&\
        docker push docker.pkg.github.com/cloudwebmanage/cwm-worker-ingress/vdns:$GITHUB_SHA &&\
        docker push docker.pkg.github.com/cloudwebmanage/cwm-worker-ingress/nginx:$GITHUB_SHA &&\
        if [ "${GITHUB_REF}" == "refs/heads/master" ]; then
          docker tag vdns docker.pkg.github.com/cloudwebmanage/cwm-worker-ingress/vdns:latest &&\
          docker tag nginx docker.pkg.github.com/cloudwebmanage/cwm-worker-ingress/nginx:latest &&\
          docker push docker.pkg.github.com/cloudwebmanage/cwm-worker-ingress/vdns:latest &&\
          docker push docker.pkg.github.com/cloudwebmanage/cwm-worker-ingress/nginx:latest
        fi
